name: Test Branch Setup

on:
  push:
    branches:
      - test

jobs:
  setup:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify Docker is available
        run: |
          docker --version
          docker compose version
      
      - name: Setup environment variables
        env:
          # Database Configuration
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_NAME: tinyurl
          DB_PORT: 5432
          
          # Redis Configuration
          REDIS_PORT: 6379
          
          # Application Configuration
          APP_HOST: http://localhost:8080
          APP_PORT: 8080
          
          # Rate Limiting Configuration
          RATE_LIMIT_SHORTEN_GET_SIZE: 10
          RATE_LIMIT_SHORTEN_GET_CAPACITY: 10
          RATE_LIMIT_SHORTEN_POST_SIZE: 5
          RATE_LIMIT_SHORTEN_POST_CAPACITY: 5
          
          # Cache Configuration
          CACHE_SHORT_URL_TTL: 120
          CACHE_LOCK_TTL: 10
          
          # Authentication Configuration
          AES_SECRET_KEY: 12345678901234567890123456789012
          AUTH_TOKEN_RANDOM_LENGTH: 32
          AUTH_TOKEN_TTL: 3600
          
          # Analytics Configuration
          ANALYTICS_TIME_KEY_FORMAT: year.month.day.hour.minute
        run: |
          # Create .env file
          cat > .env << EOF
          # Database Configuration
          DB_USERNAME=$DB_USERNAME
          DB_PASSWORD=$DB_PASSWORD
          DB_NAME=$DB_NAME
          DB_PORT=$DB_PORT
          
          # Redis Configuration
          REDIS_PORT=$REDIS_PORT
          
          # Application Configuration
          APP_HOST=$APP_HOST
          APP_PORT=$APP_PORT
          
          # Rate Limiting Configuration
          RATE_LIMIT_SHORTEN_GET_SIZE=$RATE_LIMIT_SHORTEN_GET_SIZE
          RATE_LIMIT_SHORTEN_GET_CAPACITY=$RATE_LIMIT_SHORTEN_GET_CAPACITY
          RATE_LIMIT_SHORTEN_POST_SIZE=$RATE_LIMIT_SHORTEN_POST_SIZE
          RATE_LIMIT_SHORTEN_POST_CAPACITY=$RATE_LIMIT_SHORTEN_POST_CAPACITY
          
          # Cache Configuration
          CACHE_SHORT_URL_TTL=$CACHE_SHORT_URL_TTL
          CACHE_LOCK_TTL=$CACHE_LOCK_TTL
          
          # Authentication Configuration
          AES_SECRET_KEY=$AES_SECRET_KEY
          AUTH_TOKEN_RANDOM_LENGTH=$AUTH_TOKEN_RANDOM_LENGTH
          AUTH_TOKEN_TTL=$AUTH_TOKEN_TTL
          
          # Analytics Configuration
          ANALYTICS_TIME_KEY_FORMAT=$ANALYTICS_TIME_KEY_FORMAT
          EOF
          
          echo ".env file created successfully"
          cat .env
          
          # Export environment variables
          export DB_USERNAME DB_PASSWORD DB_NAME DB_PORT
          export REDIS_PORT
          export APP_HOST APP_PORT
          export RATE_LIMIT_SHORTEN_GET_SIZE RATE_LIMIT_SHORTEN_GET_CAPACITY
          export RATE_LIMIT_SHORTEN_POST_SIZE RATE_LIMIT_SHORTEN_POST_CAPACITY
          export CACHE_SHORT_URL_TTL CACHE_LOCK_TTL
          export AES_SECRET_KEY AUTH_TOKEN_RANDOM_LENGTH AUTH_TOKEN_TTL
          export ANALYTICS_TIME_KEY_FORMAT
      
      - name: Run docker compose up --build
        env:
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_NAME: tinyurl
          DB_PORT: 5432
          REDIS_PORT: 6379
          APP_HOST: http://localhost:8080
          APP_PORT: 8080
          RATE_LIMIT_SHORTEN_GET_SIZE: 10
          RATE_LIMIT_SHORTEN_GET_CAPACITY: 10
          RATE_LIMIT_SHORTEN_POST_SIZE: 5
          RATE_LIMIT_SHORTEN_POST_CAPACITY: 5
          CACHE_SHORT_URL_TTL: 120
          CACHE_LOCK_TTL: 10
          AES_SECRET_KEY: 12345678901234567890123456789012
          AUTH_TOKEN_RANDOM_LENGTH: 32
          AUTH_TOKEN_TTL: 3600
          ANALYTICS_TIME_KEY_FORMAT: year.month.day.hour.minute
        run: |
          docker compose up --build -d
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 30
          docker compose ps
      
      - name: Verify services are running
        run: |
          if docker compose ps | grep -q "Up"; then
            echo "Services are running successfully"
          else
            echo "Warning: Some services may not be running"
            docker compose ps
          fi
      
      - name: Stop Docker Compose services
        if: always()
        run: docker compose down -v || true

