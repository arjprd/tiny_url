name: Test Branch Setup

on:
  push:
    branches:
      - test

jobs:
  setup:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify Docker is available
        run: |
          docker --version
          docker compose version
      
      - name: Make setup.sh executable
        run: chmod +x setup.sh
      
      - name: Run setup.sh with default values
        env:
          # Database Configuration
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_NAME: tinyurl
          DB_PORT: 5432
          
          # Redis Configuration
          REDIS_PORT: 6379
          
          # Application Configuration
          APP_HOST: http://localhost:8080
          APP_PORT: 8080
          
          # Rate Limiting Configuration
          RATE_LIMIT_SHORTEN_GET_SIZE: 10
          RATE_LIMIT_SHORTEN_GET_CAPACITY: 10
          RATE_LIMIT_SHORTEN_POST_SIZE: 5
          RATE_LIMIT_SHORTEN_POST_CAPACITY: 5
          
          # Cache Configuration
          CACHE_SHORT_URL_TTL: 120
          CACHE_LOCK_TTL: 10
          
          # Authentication Configuration
          AES_SECRET_KEY: 12345678901234567890123456789012
          AUTH_TOKEN_RANDOM_LENGTH: 32
          AUTH_TOKEN_TTL: 3600
          
          # Analytics Configuration
          ANALYTICS_TIME_KEY_FORMAT: year.month.day.hour.minute
          CI: true
        run: |
          # Create a wrapper script that modifies setup.sh to run docker compose in detached mode
          # Backup original setup.sh
          cp setup.sh setup.sh.backup
          
          # Modify the last line to run in detached mode
          sed -i 's/docker compose up --build/docker compose up --build -d/' setup.sh
          
          # Provide default answers to interactive prompts
          # Format: 'y' for overwrite prompt, then defaults for each prompt
          printf "y\npostgres\npostgres\ntinyurl\n5432\nhttp://localhost:8080\n8080\n6379\n10\n10\n5\n5\n120\n10\n12345678901234567890123456789012\n32\n3600\nyear.month.day.hour.minute\n" | timeout 300 ./setup.sh || true
          
          # Restore original setup.sh
          mv setup.sh.backup setup.sh
      
      - name: Verify .env file was created
        run: |
          if [ -f .env ]; then
            echo ".env file created successfully"
            cat .env
          else
            echo "Error: .env file was not created"
            exit 1
          fi
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 30
          docker compose ps
      
      - name: Verify services are running
        run: |
          if docker compose ps | grep -q "Up"; then
            echo "Services are running successfully"
          else
            echo "Warning: Some services may not be running"
            docker compose ps
          fi
      
      - name: Stop Docker Compose services
        if: always()
        run: docker compose down -v || true

