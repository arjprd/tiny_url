<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tinyurl</a> &gt; <a href="index.source.html" class="el_package">com.example.tinyurl.controller</a> &gt; <span class="el_source">UserController.java</span></div><h1>UserController.java</h1><pre class="source lang-java linenums">package com.example.tinyurl.controller;

import com.example.tinyurl.model.ChangePasswordRequest;
import com.example.tinyurl.model.CreateUserRequest;
import com.example.tinyurl.model.ErrorResponse;
import com.example.tinyurl.model.LoginRequest;
import com.example.tinyurl.model.LoginResponse;
import com.example.tinyurl.model.LogoutRequest;
import com.example.tinyurl.model.SuccessResponse;
import com.example.tinyurl.service.UserService;
import com.example.tinyurl.util.CustomAuthentication;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.ReactiveSecurityContextHolder;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

@RestController
@Tag(name = &quot;User&quot;, description = &quot;User management APIs&quot;)
public class UserController {

    private final UserService userService;

<span class="fc" id="L32">    public UserController(UserService userService) {</span>
<span class="fc" id="L33">        this.userService = userService;</span>
<span class="fc" id="L34">    }</span>

    @Operation(summary = &quot;Create a new user&quot;, description = &quot;Creates a new user with username and password&quot;)
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;User created successfully&quot;,
            content = @Content(schema = @Schema(implementation = SuccessResponse.class))),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid username (must be alphanumeric)&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),
        @ApiResponse(responseCode = &quot;409&quot;, description = &quot;Username already exists&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Server error&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class)))
    })
    @PostMapping(&quot;/user&quot;)
    public Mono&lt;ResponseEntity&lt;?&gt;&gt; createUser(@RequestBody CreateUserRequest request) {
<span class="fc" id="L49">        return userService.createUser(request.getUsername(), request.getPassword())</span>
<span class="fc" id="L50">            .map(result -&gt; {</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">                if (result.getError() != null) {</span>
                    // Return error response
<span class="fc" id="L53">                    return ResponseEntity.status(result.getStatus())</span>
<span class="fc" id="L54">                        .body(result.getError());</span>
                } else {
                    // Return success response
<span class="fc" id="L57">                    return ResponseEntity.status(result.getStatus())</span>
<span class="fc" id="L58">                        .body(result.getResponse());</span>
                }
            });
    }

    @Operation(summary = &quot;Login user&quot;, description = &quot;Authenticates user and returns a token&quot;)
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Login successful&quot;,
            content = @Content(schema = @Schema(implementation = LoginResponse.class))),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid username (must be alphanumeric)&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Invalid username or password&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Server error&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class)))
    })
    @PostMapping(&quot;/user/login&quot;)
    public Mono&lt;ResponseEntity&lt;?&gt;&gt; login(@RequestBody LoginRequest request) {
<span class="fc" id="L76">        return userService.login(request.getUsername(), request.getPassword())</span>
<span class="fc" id="L77">            .map(result -&gt; {</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">                if (result.getError() != null) {</span>
                    // Return error response
<span class="fc" id="L80">                    return ResponseEntity.status(result.getStatus())</span>
<span class="fc" id="L81">                        .body(result.getError());</span>
                } else {
                    // Return success response
<span class="fc" id="L84">                    return ResponseEntity.status(result.getStatus())</span>
<span class="fc" id="L85">                        .body(result.getResponse());</span>
                }
            });
    }

    @Operation(summary = &quot;Logout user&quot;, description = &quot;Logs out the current user by removing token(s) from Redis. Requires Bearer Token Authentication.&quot;)
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Logout successful&quot;,
            content = @Content(schema = @Schema(implementation = SuccessResponse.class))),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Bad request - either 'me' or 'all' must be true&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Unauthorized&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Server error&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class)))
    })
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    @PostMapping(&quot;/user/logout&quot;)
    public Mono&lt;ResponseEntity&lt;?&gt;&gt; logout(@RequestBody LogoutRequest request) {
        // Get userId and randomToken from request context (set by token authentication)
<span class="fc" id="L105">        return ReactiveSecurityContextHolder.getContext()</span>
<span class="fc" id="L106">            .cast(SecurityContext.class)</span>
<span class="fc" id="L107">            .map(SecurityContext::getAuthentication)</span>
<span class="fc" id="L108">            .cast(CustomAuthentication.class)</span>
<span class="fc" id="L109">            .flatMap(auth -&gt; {</span>
<span class="fc" id="L110">                Long userId = auth.getUserId();</span>
<span class="fc" id="L111">                String randomToken = auth.getCredentials();</span>
<span class="fc" id="L112">                return userService.logout(userId, randomToken, request.getMe(), request.getAll())</span>
<span class="fc" id="L113">                    .map(result -&gt; {</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                        if (result.getError() != null) {</span>
                            // Return error response
<span class="fc" id="L116">                            return ResponseEntity.status(result.getStatus())</span>
<span class="fc" id="L117">                                .body(result.getError());</span>
                        } else {
                            // Return success response
<span class="fc" id="L120">                            return ResponseEntity.status(result.getStatus())</span>
<span class="fc" id="L121">                                .body(result.getResponse());</span>
                        }
                    });
            })
<span class="fc" id="L125">            .switchIfEmpty(Mono.just(ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="fc" id="L126">                .body(new ErrorResponse(&quot;UNAUTHORIZED&quot;, &quot;Invalid token&quot;))));</span>
    }

    @Operation(summary = &quot;Change password&quot;, description = &quot;Changes the user's password. Requires Bearer Token Authentication.&quot;)
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Password updated successfully&quot;,
            content = @Content(schema = @Schema(implementation = SuccessResponse.class))),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Invalid old password&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),
        @ApiResponse(responseCode = &quot;404&quot;, description = &quot;User not found&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Server error&quot;,
            content = @Content(schema = @Schema(implementation = ErrorResponse.class)))
    })
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    @PatchMapping(&quot;/user&quot;)
    public Mono&lt;ResponseEntity&lt;?&gt;&gt; changePassword(@RequestBody ChangePasswordRequest request) {
        // Get userId from request context (set by token authentication)
<span class="fc" id="L144">        return ReactiveSecurityContextHolder.getContext()</span>
<span class="fc" id="L145">            .cast(SecurityContext.class)</span>
<span class="fc" id="L146">            .map(SecurityContext::getAuthentication)</span>
<span class="fc" id="L147">            .cast(CustomAuthentication.class)</span>
<span class="fc" id="L148">            .map(CustomAuthentication::getUserId)</span>
<span class="fc" id="L149">            .flatMap(userId -&gt; userService.changePassword(userId, request.getOldPassword(), request.getNewPassword())</span>
<span class="fc" id="L150">                .map(result -&gt; {</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">                    if (result.getError() != null) {</span>
                        // Return error response
<span class="fc" id="L153">                        return ResponseEntity.status(result.getStatus())</span>
<span class="fc" id="L154">                            .body(result.getError());</span>
                    } else {
                        // Return success response
<span class="fc" id="L157">                        return ResponseEntity.status(result.getStatus())</span>
<span class="fc" id="L158">                            .body(result.getResponse());</span>
                    }
                }))
<span class="fc" id="L161">            .switchIfEmpty(Mono.just(ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="fc" id="L162">                .body(new ErrorResponse(&quot;UNAUTHORIZED&quot;, &quot;Invalid token&quot;))));</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>